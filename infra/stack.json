{
    "AWSTemplateFormatVersion": "2010-09-09",
    "Description": "",
    "Parameters": {
        "DBUsername": {
            "NoEcho": "true",
            "Description": "Username for database access",
            "Type": "String",
            "MinLength": "1",
            "MaxLength": "16",
            "AllowedPattern": "[a-zA-Z][a-zA-Z0-9]*",
            "ConstraintDescription": "must begin with a letter and contain only alphanumeric characters."
        },
        "DBPassword": {
            "NoEcho": "true",
            "Description": "Password for database access",
            "Type": "String",
            "MinLength": "16",
            "MaxLength": "41"
        },
        "SecretKey": {
            "NoEcho": "true",
            "Description": "Secret key for Play application",
            "Type": "String",
            "MinLength": "12",
            "MaxLength": "64"
        },
        "Timestamp": {
            "Description": "Current timestamp in seconds.",
            "Type": "Number"
        }
    },
    "Resources": {
            "VPC": {
                    "Type": "AWS::CloudFormation::Stack",
                    "Properties": {
                            "TemplateURL": {"Fn::Sub": "https://s3.amazonaws.com/seattle-uat-cftmpl/${Timestamp}/network.json"}
                    }
            },
            "SecurityGroups": {
                    "Type": "AWS::CloudFormation::Stack",
                    "Properties": {
                            "TemplateURL": {"Fn::Sub": "https://s3.amazonaws.com/seattle-uat-cftmpl/${Timestamp}/security_groups.json"},
                            "Parameters": {
                                    "VPCId": {"Fn::GetAtt": ["VPC", "Outputs.VPCId"]}
                            }
                    }
            },
            "LB": {
                    "Type": "AWS::CloudFormation::Stack",
                    "Properties": {
                            "TemplateURL": {"Fn::Sub": "https://s3.amazonaws.com/seattle-uat-cftmpl/${Timestamp}/load_balancer.json"},
                            "Parameters": {
                                    "VPCId": {"Fn::GetAtt": ["VPC", "Outputs.VPCId"]},
                                    "PublicSubnets": {"Fn::GetAtt": ["VPC", "Outputs.PublicSubnets"]},
                                    "LBSecurityGroup": {"Fn::GetAtt": ["SecurityGroups", "Outputs.LbGroup"]}
                            }
                    }
            },
            "DB": {
                    "Type": "AWS::CloudFormation::Stack",
                    "Properties": {
                            "TemplateURL": {"Fn::Sub": "https://s3.amazonaws.com/seattle-uat-cftmpl/${Timestamp}/database.json"},
                            "Parameters": {
                                    "DBUsername": {"Ref": "DBUsername"},
                                    "DBPassword": {"Ref": "DBPassword"},
                                    "DBSecurityGroup": {"Fn::GetAtt": ["SecurityGroups", "Outputs.DatabaseGroup"]},
                                    "PrivateSubnets": {"Fn::GetAtt": ["VPC", "Outputs.PrivateSubnets"]}
                            }
                    }
            },
            "Container": {
                    "Type": "AWS::CloudFormation::Stack",
                    "Properties": {
                            "TemplateURL": {"Fn::Sub": "https://s3.amazonaws.com/seattle-uat-cftmpl/${Timestamp}/containers.json"},
                            "Parameters": {
                                    "DBUsername": {"Ref": "DBUsername"},
                                    "DBPassword": {"Ref": "DBPassword"},
                                    "DBAddress": {"Fn::GetAtt": ["DB", "Outputs.DBAddress"]},
                                    "DBPort": {"Fn::GetAtt": ["DB", "Outputs.DBPort"]},
                                    "SecretKey": {"Ref": "SecretKey"},
                                    "PrivateSubnets": {"Fn::GetAtt": ["VPC", "Outputs.PrivateSubnets"]},
                                    "LBTargetName": {"Fn::GetAtt": ["LB", "Outputs.LBTarget"]},
                                    "ContainerSecurityGroup": {"Fn::GetAtt": ["SecurityGroups", "Outputs.ContainerGroup"]}
                            }
                    }
            }
    }
}
