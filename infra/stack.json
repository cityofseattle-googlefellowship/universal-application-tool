{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "",
  "Parameters": {
    "DBUsername": {
      "NoEcho": "true",
      "Description": "Username for database access",
      "Type": "String",
      "MinLength": "1",
      "MaxLength": "16",
      "AllowedPattern": "[a-zA-Z][a-zA-Z0-9]*",
      "ConstraintDescription": "must begin with a letter and contain only alphanumeric characters."
    },
    "DBPassword": {
      "NoEcho": "true",
      "Description": "Password for database access",
      "Type": "String",
      "MinLength": "16",
      "MaxLength": "64"
    },
    "SecretKey": {
      "NoEcho": "true",
      "Description": "Secret key for Play application",
      "Type": "String",
      "MinLength": "12",
      "MaxLength": "64"
    },
    "Timestamp": {
      "Description": "Current timestamp in seconds.",
      "Type": "Number"
    }
  },
  "Resources": {
    "VPC": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "TemplateURL": {
          "Fn::Sub": "https://s3.amazonaws.com/seattle-uat-cftmpl/${Timestamp}/network.json"
        }
      }
    },
    "SecurityGroups": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "TemplateURL": {
          "Fn::Sub": "https://s3.amazonaws.com/seattle-uat-cftmpl/${Timestamp}/security_groups.json"
        },
        "Parameters": {
          "VPCId": {
            "Fn::GetAtt": [
              "VPC",
              "Outputs.VPCId"
            ]
          }
        }
      }
    },
    "LB": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "TemplateURL": {
          "Fn::Sub": "https://s3.amazonaws.com/seattle-uat-cftmpl/${Timestamp}/load_balancer.json"
        },
        "Parameters": {
          "VPCId": {
            "Fn::GetAtt": [
              "VPC",
              "Outputs.VPCId"
            ]
          },
          "PublicSubnet1": {
            "Fn::GetAtt": [
              "VPC",
              "Outputs.PublicSubnet1"
            ]
          },
          "PublicSubnet2": {
            "Fn::GetAtt": [
              "VPC",
              "Outputs.PublicSubnet2"
            ]
          },
          "LBSecurityGroup": {
            "Fn::GetAtt": [
              "SecurityGroups",
              "Outputs.LbGroup"
            ]
          }
        }
      }
    },
    "DB": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "TemplateURL": {
          "Fn::Sub": "https://s3.amazonaws.com/seattle-uat-cftmpl/${Timestamp}/database.json"
        },
        "Parameters": {
          "DBUsername": {
            "Ref": "DBUsername"
          },
          "DBPassword": {
            "Ref": "DBPassword"
          },
          "DBSecurityGroup": {
            "Fn::GetAtt": [
              "SecurityGroups",
              "Outputs.DatabaseGroup"
            ]
          },
          "PrivateSubnet1": {
            "Fn::GetAtt": [
              "VPC",
              "Outputs.PrivateSubnet1"
            ]
          },
          "PrivateSubnet2": {
            "Fn::GetAtt": [
              "VPC",
              "Outputs.PrivateSubnet2"
            ]
          }
        }
      }
    },
    "Container": {
      "Type": "AWS::CloudFormation::Stack",
      "Properties": {
        "TemplateURL": {
          "Fn::Sub": "https://s3.amazonaws.com/seattle-uat-cftmpl/${Timestamp}/containers.json"
        },
        "Parameters": {
          "DBUsername": {
            "Ref": "DBUsername"
          },
          "DBPassword": {
            "Ref": "DBPassword"
          },
          "DBAddress": {
            "Fn::GetAtt": [
              "DB",
              "Outputs.DBAddress"
            ]
          },
          "DBPort": {
            "Fn::GetAtt": [
              "DB",
              "Outputs.DBPort"
            ]
          },
          "SecretKey": {
            "Ref": "SecretKey"
          },
          "PrivateSubnet1": {
            "Fn::GetAtt": [
              "VPC",
              "Outputs.PrivateSubnet1"
            ]
          },
          "PrivateSubnet2": {
            "Fn::GetAtt": [
              "VPC",
              "Outputs.PrivateSubnet2"
            ]
          },
          "LBTargetName": {
            "Fn::GetAtt": [
              "LB",
              "Outputs.LBTarget"
            ]
          },
          "ContainerSecurityGroup": {
            "Fn::GetAtt": [
              "SecurityGroups",
              "Outputs.ContainerGroup"
            ]
          }
        }
      }
    }
  }
}
