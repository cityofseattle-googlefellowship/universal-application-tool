#!/bin/bash
pushd $(git rev-parse --show-toplevel)

set -e

bin/pull-image

if [ -f ".secrets" ]; then
    . .secrets
fi

if [ "$DISABLE_LOCALSTACK" ]; then
  services=$(docker-compose ps --services | grep -v localstack | xargs)
  echo "localstack is disabled, only starting $services..."
  docker-compose up $services
  exit $?
fi
echo "Starting localstack... set environment variable DISABLE_LOCALSTACK=1 to skip"

# start localstack
docker-compose -f docker-compose.yml -f docker-compose.dev.yml up -d localstack

# wait till localstack running
# otherwise other services crash
bin/localstack/wait

# ensure local s3 created
bin/localstack/mk-s3

# start everything else
docker-compose -f docker-compose.yml -f docker-compose.dev.yml up

popd
