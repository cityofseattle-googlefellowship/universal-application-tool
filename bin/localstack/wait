#!/bin/bash

localstack_endpoint=http://localhost:4566

if [ "$1" ]; then
    localstack_endpoint=$1
fi

start_time=$(date +%s)
deadline=$(($start_time + 200))

echo "Waiting for localstack to get set up. This may take a minute or two..."

until HEALTHCHECK=$(curl --silent --fail --max-time 2 $localstack_endpoint/health) && [[ $HEALTHCHECK == *'"s3": "running"'* ]]; do
    if (( $(date +%s) > $deadline )); then
        echo "deadline exceeded waiting for localstack start"
        exit 1
    fi
done
